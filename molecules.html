<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Molecule Viewer | Coral & Climate</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', -apple-system, sans-serif;
            background: #0a1929;
            color: #fff;
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1.5rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 25, 41, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
        }

        .nav-logo {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: #ffa07a;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            list-style: none;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-links a:hover {
            color: #ffa07a;
        }

        /* Active link: underline (match global site style) */
        .nav-links a.active {
            color: #ffa07a;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 1px;
            background: #ffa07a;
            transition: width 0.3s ease;
        }

        .nav-links a:hover::after,
        .nav-links a.active::after {
            width: 100%;
        }

        @media (max-width: 900px) {
            nav {
                padding: 1rem 1.5rem;
            }
            .nav-links {
                display: none;
            }
        }

        .molecule-viewer {
            max-width: 1000px;
            margin: 0 auto;
            padding: 7rem 2rem 2rem;
        }

        h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
            color: #ffa07a;
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.7);
            margin-bottom: 2rem;
        }

        .molecule-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #ff6b6b, #ffa07a);
            border-color: transparent;
            color: #fff;
        }

        .viewer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 768px) {
            .viewer-container {
                grid-template-columns: 1fr;
            }
        }

        .canvas-container {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 1;
            position: relative;
        }

        #molecule-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls-hint {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }

        .molecule-info {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 2rem;
        }

        .molecule-info h2 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.5rem;
            color: #5fdcd4;
            margin-bottom: 1rem;
        }

        .molecule-info h3 {
            font-size: 1.1rem;
            color: #ffa07a;
            margin: 1.5rem 0 0.75rem;
        }

        .molecule-info p {
            color: rgba(255,255,255,0.7);
            line-height: 1.7;
            margin-bottom: 0.75rem;
        }

        .formula {
            font-family: monospace;
            background: rgba(32, 178, 170, 0.2);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: #5fdcd4;
            font-size: 1.2rem;
            display: inline-block;
            margin: 0.5rem 0;
        }

        .legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .legend-dot.carbon { background: #505050; }
        .legend-dot.oxygen { background: #ff4444; }
        .legend-dot.calcium { background: #44bb44; }
        .legend-dot.hydrogen { background: #ffffff; border: 1px solid rgba(255,255,255,0.3); }

        /* Reaction Diagram Section */
        .reaction-section {
            margin-top: 3rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 2rem;
        }

        .reaction-section h2 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 1.5rem;
            color: #ff6b6b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .reaction-canvas-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            height: 300px;
            margin: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        #reaction-canvas {
            width: 100%;
            height: 100%;
        }

        .reaction-hint {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }

        .reaction-equation {
            text-align: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .reaction-equation .formula {
            font-size: 1rem;
        }

        .reaction-description {
            text-align: center;
            color: rgba(255,255,255,0.7);
            margin-top: 1rem;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="nav-logo">Coral & Climate</a>
        <ul class="nav-links">
            <li><a href="great-barrier-reef.html">Great Barrier Reef</a></li>
            <li><a href="structure.html">Coral Structure</a></li>
            <li><a href="carbon-dioxide.html">Carbon Dioxide</a></li>
            <li><a href="bleaching.html">Bleaching</a></li>
            <li><a href="why-it-matters.html">Why It Matters</a></li>
            <li><a href="molecules.html" class="active">3D Molecules</a></li>
        </ul>
    </nav>

    <div class="molecule-viewer">
        <h1>Interactive 3D Molecules</h1>
        <p class="subtitle">Explore the chemistry of ocean acidification</p>

        <div class="molecule-tabs">
            <button class="tab-btn active" data-key="co2" onclick="showMolecule('co2', this)">Carbon Dioxide (CO₂)</button>
            <button class="tab-btn" data-key="carbonate" onclick="showMolecule('carbonate', this)">Carbonate (CO₃²⁻)</button>
            <button class="tab-btn" data-key="bicarbonate" onclick="showMolecule('bicarbonate', this)">Bicarbonate (HCO₃⁻)</button>
            <button class="tab-btn" data-key="calcium-carbonate" onclick="showMolecule('calcium-carbonate', this)">Calcium Carbonate (CaCO₃)</button>
        </div>

        <div class="viewer-container">
            <div class="canvas-container">
                <canvas id="molecule-canvas"></canvas>
                <div class="controls-hint">Click and drag to rotate</div>
            </div>
            
            <div class="molecule-info" id="molecule-info">
                <!-- Content updated by JavaScript -->
            </div>
        </div>

        <div class="reaction-section">
            <h2>Ocean Acidification Reaction</h2>
            <p style="text-align: center; color: rgba(255,255,255,0.7); margin-bottom: 1rem;">
                See how CO₂ reacts with water to form carbonic acid, then releases hydrogen ions
            </p>
            <div class="reaction-canvas-container">
                <canvas id="reaction-canvas"></canvas>
                <div class="reaction-hint">Click and drag to rotate</div>
            </div>
            <div class="reaction-equation">
                <span class="formula">CO₂ + H₂O → H₂CO₃ → H⁺ + HCO₃⁻</span>
            </div>
            <p class="reaction-description">
                Excess hydrogen ions (H⁺) then react with carbonate ions (CO₃²⁻), 
                reducing the carbonate available for coral calcification.
            </p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Molecule data
        const molecules = {
            'co2': {
                name: 'Carbon Dioxide',
                formula: 'CO₂',
                atoms: [
                    { element: 'O', position: [-2, 0, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'C', position: [0, 0, 0], color: 0x505050, radius: 0.5 },
                    { element: 'O', position: [2, 0, 0], color: 0xff4444, radius: 0.6 }
                ],
                bonds: [
                    { start: 0, end: 1, type: 'double' },
                    { start: 1, end: 2, type: 'double' }
                ],
                info: {
                    structure: 'Linear molecule with a central carbon atom double-bonded to two oxygen atoms. Bond angle: 180°.',
                    properties: 'Colorless, odorless gas. Soluble in water where it forms carbonic acid.',
                    role: 'Primary greenhouse gas driving ocean acidification. When dissolved in seawater, it initiates a cascade of chemical reactions that lower pH.'
                }
            },
            'carbonate': {
                name: 'Carbonate Ion',
                formula: 'CO₃²⁻',
                atoms: [
                    { element: 'C', position: [0, 0, 0], color: 0x505050, radius: 0.5 },
                    { element: 'O', position: [0, 1.5, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'O', position: [-1.3, -0.75, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'O', position: [1.3, -0.75, 0], color: 0xff4444, radius: 0.6 }
                ],
                bonds: [
                    { start: 0, end: 1, type: 'partial' },
                    { start: 0, end: 2, type: 'partial' },
                    { start: 0, end: 3, type: 'partial' }
                ],
                info: {
                    structure: 'Trigonal planar structure with carbon at center. The -2 charge is delocalized across all three oxygen atoms through resonance.',
                    properties: 'Highly reactive due to its -2 charge. Acts as a weak base. Essential for coral calcification.',
                    role: 'Corals extract carbonate ions from seawater to build calcium carbonate skeletons. Ocean acidification depletes carbonate by reacting it with excess H⁺ ions.'
                }
            },
            'bicarbonate': {
                name: 'Bicarbonate Ion',
                formula: 'HCO₃⁻',
                atoms: [
                    { element: 'C', position: [0, 0, 0], color: 0x505050, radius: 0.5 },
                    { element: 'O', position: [0, 1.5, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'O', position: [-1.3, -0.75, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'O', position: [1.3, -0.75, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'H', position: [2.1, -1.2, 0], color: 0xffffff, radius: 0.3 }
                ],
                bonds: [
                    { start: 0, end: 1, type: 'double' },
                    { start: 0, end: 2, type: 'single' },
                    { start: 0, end: 3, type: 'single' },
                    { start: 3, end: 4, type: 'single' }
                ],
                info: {
                    structure: 'Similar to carbonate but with one hydrogen attached. The -1 charge is distributed across the oxygen atoms.',
                    properties: 'More stable than carbonate due to lower charge density. Forms strong hydrogen bonds with water.',
                    role: 'The dominant form of dissolved carbon in seawater. As pH drops, the equilibrium shifts toward bicarbonate and away from carbonate.'
                }
            },
            'calcium-carbonate': {
                name: 'Calcium Carbonate',
                formula: 'CaCO₃',
                atoms: [
                    { element: 'Ca', position: [-2, 0, 0], color: 0x44bb44, radius: 0.8 },
                    { element: 'C', position: [1.5, 0, 0], color: 0x505050, radius: 0.5 },
                    { element: 'O', position: [1.5, 1.5, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'O', position: [0.2, -0.75, 0], color: 0xff4444, radius: 0.6 },
                    { element: 'O', position: [2.8, -0.75, 0], color: 0xff4444, radius: 0.6 }
                ],
                bonds: [
                    { start: 1, end: 2, type: 'partial' },
                    { start: 1, end: 3, type: 'partial' },
                    { start: 1, end: 4, type: 'partial' },
                    { start: 0, end: 3, type: 'ionic' }
                ],
                info: {
                    structure: 'Ionic compound with Ca²⁺ cation and CO₃²⁻ anion held together by electrostatic attraction.',
                    properties: 'Forms crystalline structures (aragonite in coral). Insoluble in water under normal conditions but dissolves in acidic water.',
                    role: 'The primary building block of coral skeletons. Corals extract Ca²⁺ and CO₃²⁻ from seawater to form CaCO₃ through calcification.'
                }
            }
        };

        // Centralized element color mapping (lowercase keys)
        const elementColors = {
            c: 0x505050,    // Carbon
            o: 0xff4444,    // Oxygen
            ca: 0x44bb44,   // Calcium
            h: 0xffffff     // Hydrogen
        };

        let scene, camera, renderer, moleculeGroup;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        // Initialize main molecule viewer
        function initMoleculeViewer() {
            const canvas = document.getElementById('molecule-canvas');
            const container = canvas.parentElement;
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1520);
            
            camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            camera.position.z = 8;
            
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0x5fdcd4, 0.3);
            backLight.position.set(-5, -5, -5);
            scene.add(backLight);
            
            moleculeGroup = new THREE.Group();
            scene.add(moleculeGroup);
            
            // Mouse controls
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                moleculeGroup.rotation.y += deltaX * 0.01;
                moleculeGroup.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => isDragging = false);
            canvas.addEventListener('mouseleave', () => isDragging = false);
            
            // Touch controls
            canvas.addEventListener('touchstart', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.touches[0].clientX - previousMousePosition.x;
                const deltaY = e.touches[0].clientY - previousMousePosition.y;
                
                moleculeGroup.rotation.y += deltaX * 0.01;
                moleculeGroup.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            });
            
            canvas.addEventListener('touchend', () => isDragging = false);
            
            showMolecule('co2');
            animate();
        }

        function createMolecule(moleculeData) {
            // Clear existing molecule
            while(moleculeGroup.children.length > 0) {
                moleculeGroup.remove(moleculeGroup.children[0]);
            }
            
            // Create atoms
            moleculeData.atoms.forEach((atom, index) => {
                const geometry = new THREE.SphereGeometry(atom.radius, 32, 32);
                const elKey = String(atom.element).toLowerCase();
                const matColor = elementColors[elKey] !== undefined ? elementColors[elKey] : atom.color;
                const material = new THREE.MeshPhongMaterial({ 
                    color: matColor,
                    shininess: 100,
                    specular: 0x444444
                });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(...atom.position);
                moleculeGroup.add(sphere);
            });
            
            // Create bonds
            moleculeData.bonds.forEach(bond => {
                const startAtom = moleculeData.atoms[bond.start];
                const endAtom = moleculeData.atoms[bond.end];
                
                const start = new THREE.Vector3(...startAtom.position);
                const end = new THREE.Vector3(...endAtom.position);
                
                if (bond.type === 'ionic') {
                    // Dashed line for ionic bonds
                    const points = [start, end];
                    const geometry = new THREE.BufferGeometry().setFromPoints(points);
                    const material = new THREE.LineDashedMaterial({ 
                        color: 0x5fdcd4, 
                        dashSize: 0.2, 
                        gapSize: 0.1 
                    });
                    const line = new THREE.Line(geometry, material);
                    line.computeLineDistances();
                    moleculeGroup.add(line);
                } else {
                    // Cylinder for covalent bonds
                    const direction = new THREE.Vector3().subVectors(end, start);
                    const length = direction.length() - startAtom.radius - endAtom.radius + 0.2;
                    
                    const bondGeometry = new THREE.CylinderGeometry(0.08, 0.08, length, 8);
                    const bondMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
                    
                    const bondMesh = new THREE.Mesh(bondGeometry, bondMaterial);
                    
                    const midpoint = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
                    bondMesh.position.copy(midpoint);
                    
                    bondMesh.quaternion.setFromUnitVectors(
                        new THREE.Vector3(0, 1, 0),
                        direction.normalize()
                    );
                    
                    moleculeGroup.add(bondMesh);
                    
                    // Double bond
                    if (bond.type === 'double') {
                        const offset = new THREE.Vector3(0.15, 0, 0.15);
                        const bondMesh2 = bondMesh.clone();
                        bondMesh.position.add(offset);
                        bondMesh2.position.sub(offset);
                        moleculeGroup.add(bondMesh2);
                    }
                }
            });
            
            moleculeGroup.rotation.set(0.3, 0.5, 0);
        }

        function showMolecule(moleculeKey, btn) {
            const data = molecules[moleculeKey];
            createMolecule(data);
            
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (btn && btn.classList) {
                btn.classList.add('active');
            } else {
                const found = document.querySelector(`.tab-btn[data-key="${moleculeKey}"]`);
                if (found) found.classList.add('active');
            }
            
            // Update info panel
            const infoPanel = document.getElementById('molecule-info');
            infoPanel.innerHTML = `
                <h2>${data.name}</h2>
                <div class="formula">${data.formula}</div>
                
                <h3>Structure</h3>
                <p>${data.info.structure}</p>
                
                <h3>Properties</h3>
                <p>${data.info.properties}</p>
                
                <h3>Role in Ocean Acidification</h3>
                <p>${data.info.role}</p>
                
                <div class="legend">
                    <div class="legend-item"><span class="legend-dot carbon"></span> Carbon</div>
                    <div class="legend-item"><span class="legend-dot oxygen"></span> Oxygen</div>
                    <div class="legend-item"><span class="legend-dot calcium"></span> Calcium</div>
                    <div class="legend-item"><span class="legend-dot hydrogen"></span> Hydrogen</div>
                </div>
            `;
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (!isDragging) {
                moleculeGroup.rotation.y += 0.005;
            }
            
            renderer.render(scene, camera);
        }

        // Reaction Diagram (Static, Rotatable)
        let reactionScene, reactionCamera, reactionRenderer;
        let reactionGroup;
        let isReactionDragging = false;
        let prevReactionMouse = { x: 0, y: 0 };

        function initReactionViewer() {
            const canvas = document.getElementById('reaction-canvas');
            const container = canvas.parentElement;
            
            reactionScene = new THREE.Scene();
            reactionScene.background = new THREE.Color(0x0a1520);
            
            reactionCamera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            // Slightly zoomed in previously; move camera back a bit to zoom out slightly
            reactionCamera.position.z = 10;
            
            reactionRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            reactionRenderer.setSize(container.clientWidth, container.clientHeight);
            reactionRenderer.setPixelRatio(window.devicePixelRatio);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            reactionScene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            reactionScene.add(directionalLight);
            
            // Create the reaction group (everything rotates together)
            reactionGroup = new THREE.Group();
            // Scale was increased previously; reduce slightly to zoom out a little
            reactionGroup.scale.set(1.15, 1.15, 1.15);
            reactionScene.add(reactionGroup);
            
            buildReactionDiagram();
            
            // Mouse controls for rotation
            canvas.addEventListener('mousedown', (e) => {
                isReactionDragging = true;
                prevReactionMouse = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isReactionDragging) return;
                const deltaX = e.clientX - prevReactionMouse.x;
                const deltaY = e.clientY - prevReactionMouse.y;
                reactionGroup.rotation.y += deltaX * 0.01;
                reactionGroup.rotation.x += deltaY * 0.01;
                prevReactionMouse = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => isReactionDragging = false);
            canvas.addEventListener('mouseleave', () => isReactionDragging = false);
            
            // Touch controls
            canvas.addEventListener('touchstart', (e) => {
                isReactionDragging = true;
                prevReactionMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (!isReactionDragging) return;
                const deltaX = e.touches[0].clientX - prevReactionMouse.x;
                const deltaY = e.touches[0].clientY - prevReactionMouse.y;
                reactionGroup.rotation.y += deltaX * 0.01;
                reactionGroup.rotation.x += deltaY * 0.01;
                prevReactionMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            });
            
            canvas.addEventListener('touchend', () => isReactionDragging = false);
            
            animateReaction();
        }

        function buildReactionDiagram() {
            // Layout: CO2 + H2O → H2CO3 → H+ + HCO3-
            // Positions spread across x-axis
            
            // CO2 (position: -7)
            const co2 = createCO2();
            co2.position.set(-7, 0, 0);
            reactionGroup.add(co2);
            
            // Plus sign (position: -5)
            const plus1 = createPlusSign();
            plus1.position.set(-5, 0, 0);
            reactionGroup.add(plus1);
            
            // H2O (position: -3)
            const h2o = createH2O();
            h2o.position.set(-3, 0, 0);
            reactionGroup.add(h2o);
            
            // Arrow (position: -1)
            const arrow1 = createArrow();
            arrow1.position.set(-1, 0, 0);
            reactionGroup.add(arrow1);
            
            // H2CO3 (position: 1.5)
            const h2co3 = createH2CO3();
            h2co3.position.set(1.5, 0, 0);
            reactionGroup.add(h2co3);
            
            // Arrow (position: 4)
            const arrow2 = createArrow();
            arrow2.position.set(4, 0, 0);
            reactionGroup.add(arrow2);
            
            // H+ (position: 5.5)
            const hPlus = createHPlus();
            hPlus.position.set(5.5, 0.5, 0);
            reactionGroup.add(hPlus);
            
            // Plus sign (position: 6.5)
            const plus2 = createPlusSign();
            plus2.position.set(6.5, 0, 0);
            reactionGroup.add(plus2);
            
            // HCO3- (position: 8)
            const hco3 = createHCO3();
            hco3.position.set(8, -0.3, 0);
            reactionGroup.add(hco3);
        }

        function createCO2() {
            const group = new THREE.Group();
            const cMat = new THREE.MeshPhongMaterial({ color: elementColors['c'] });
            const oMat = new THREE.MeshPhongMaterial({ color: elementColors['o'] });
            
            const c = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), cMat);
            const o1 = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), oMat);
            const o2 = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), oMat);
            
            o1.position.x = -0.9;
            o2.position.x = 0.9;
            
            group.add(c, o1, o2);
            return group;
        }

        function createH2O() {
            const group = new THREE.Group();
            const oMat = new THREE.MeshPhongMaterial({ color: elementColors['o'] });
            const hMat = new THREE.MeshPhongMaterial({ color: elementColors['h'] });
            
            const o = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), oMat);
            const h1 = new THREE.Mesh(new THREE.SphereGeometry(0.22, 32, 32), hMat);
            const h2 = new THREE.Mesh(new THREE.SphereGeometry(0.22, 32, 32), hMat);
            
            h1.position.set(-0.5, 0.4, 0);
            h2.position.set(0.5, 0.4, 0);
            
            group.add(o, h1, h2);
            return group;
        }

        function createH2CO3() {
            const group = new THREE.Group();
            const cMat = new THREE.MeshPhongMaterial({ color: elementColors['c'] });
            const oMat = new THREE.MeshPhongMaterial({ color: elementColors['o'] });
            const hMat = new THREE.MeshPhongMaterial({ color: elementColors['h'] });
            
            const c = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 32), cMat);
            const o1 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), oMat);
            const o2 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), oMat);
            const o3 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), oMat);
            const h1 = new THREE.Mesh(new THREE.SphereGeometry(0.18, 32, 32), hMat);
            const h2 = new THREE.Mesh(new THREE.SphereGeometry(0.18, 32, 32), hMat);
            
            o1.position.set(0, 0.8, 0);
            o2.position.set(-0.7, -0.4, 0);
            o3.position.set(0.7, -0.4, 0);
            h1.position.set(-1.1, -0.7, 0);
            h2.position.set(1.1, -0.7, 0);
            
            group.add(c, o1, o2, o3, h1, h2);
            return group;
        }

        function createHPlus() {
            const group = new THREE.Group();
            const hMat = new THREE.MeshPhongMaterial({ color: elementColors['h'] });
            const h = new THREE.Mesh(new THREE.SphereGeometry(0.25, 32, 32), hMat);
            group.add(h);
            return group;
        }

        function createHCO3() {
            const group = new THREE.Group();
            const cMat = new THREE.MeshPhongMaterial({ color: elementColors['c'] });
            const oMat = new THREE.MeshPhongMaterial({ color: elementColors['o'] });
            const hMat = new THREE.MeshPhongMaterial({ color: elementColors['h'] });
            
            const c = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 32), cMat);
            const o1 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), oMat);
            const o2 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), oMat);
            const o3 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), oMat);
            const h = new THREE.Mesh(new THREE.SphereGeometry(0.18, 32, 32), hMat);
            
            o1.position.set(0, 0.75, 0);
            o2.position.set(-0.65, -0.35, 0);
            o3.position.set(0.65, -0.35, 0);
            h.position.set(1.05, -0.6, 0);
            
            group.add(c, o1, o2, o3, h);
            return group;
        }

        function createArrow() {
            const group = new THREE.Group();
            const mat = new THREE.MeshPhongMaterial({ color: 0x5fdcd4 });
            
            // Arrow shaft
            const shaft = new THREE.Mesh(
                new THREE.BoxGeometry(0.6, 0.1, 0.1),
                mat
            );
            shaft.position.x = -0.1;
            
            // Arrow head
            const head = new THREE.Mesh(
                new THREE.ConeGeometry(0.15, 0.3, 8),
                mat
            );
            head.rotation.z = -Math.PI / 2;
            head.position.x = 0.35;
            
            group.add(shaft, head);
            return group;
        }

        function createPlusSign() {
            const group = new THREE.Group();
            const mat = new THREE.MeshPhongMaterial({ color: 0x5fdcd4 });
            
            const horiz = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 0.1), mat);
            const vert = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.4, 0.1), mat);
            
            group.add(horiz, vert);
            return group;
        }

        function animateReaction() {
            requestAnimationFrame(animateReaction);
            reactionRenderer.render(reactionScene, reactionCamera);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('molecule-canvas').parentElement;
            renderer.setSize(container.clientWidth, container.clientHeight);
            
            const reactionContainer = document.getElementById('reaction-canvas').parentElement;
            reactionRenderer.setSize(reactionContainer.clientWidth, reactionContainer.clientHeight);
            reactionCamera.aspect = reactionContainer.clientWidth / reactionContainer.clientHeight;
            reactionCamera.updateProjectionMatrix();
        });

        // Initialize on load
        window.addEventListener('load', () => {
            initMoleculeViewer();
            initReactionViewer();
        });
    </script>

    <footer>
        <div class="footer-content">
            <div class="footer-brand">
                <a href="index.html" class="nav-logo">Coral & Climate</a>
                <p>An educational resource about ocean acidification and coral bleaching.</p>
            </div>
            <div class="footer-links">
                <h4>Explore</h4>
                <ul>
                    <li><a href="great-barrier-reef.html">Great Barrier Reef</a></li>
                    <li><a href="structure.html">Coral Structure</a></li>
                    <li><a href="carbon-dioxide.html">Carbon Dioxide</a></li>
                    <li><a href="bleaching.html">Bleaching</a></li>
                    <li><a href="why-it-matters.html">Why It Matters</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>Resources</h4>
                <ul>
                    <li><a href="https://www.gbrmpa.gov.au/" target="_blank">Great Barrier Reef Marine Park</a></li>
                    <li><a href="https://coral.org/" target="_blank">Coral Reef Alliance</a></li>
                    <li><a href="references.html">References</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Educational content on ocean acidification and coral bleaching.</p>
        </div>
    </footer>

</body>
</html>